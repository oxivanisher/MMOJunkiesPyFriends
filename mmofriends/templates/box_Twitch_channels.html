<ul id="twitchChannelsOnline" class="list-group" style="margin-bottom: 0px;"></ul>
<ul id="twitchChannelsOffline" class="list-group" style="margin-bottom: 0px;"></ul>
<script type="text/javascript">
	(function () {
		function drawStreamContent( data, drawOnline ) {
			showMe = false
			for (id in data.streams) {
				s = data.streams[id];
				if (data.channels[id]) {
					display_name = '<img class="partner_list_icon" src="{{ url_for('get_image', imgType='network', imgId='System') }}" title="{{ box.netHandle }}" /> ' + data.channels[id].display_name;
					url = data.channels[id].url;
				} else {
					display_name = '<img class="partner_list_icon" src="{{ url_for('get_image', imgType='network', imgId=box.netHandle) }}" title="{{ box.netHandle }}" /> ' + id;
					url = "http://twitch.tv/" + id;
				}
				
				var image = "";
				var status = "text-warning";
				var glyph = "glyphicon-remove";
				var online = false;
				if (s.stream) {
					imgUrl = s.stream.preview + "?" + new Date().getTime();
					image = "<img class='img-responsive' src='" + imgUrl + "' title='" + s.stream.game + ": " + s.status + "'/>";
					status = "text-success";
					glyph = "glyphicon-ok";
					display_name = display_name + " (" + s.stream.viewers + " viewers)";
					online = true;
				}
				var onclick = 'onclick="window.open(\'' + url + '\')"';
				var icon = '<span class="glyphicon ' + glyph + ' ' + status + ' pull-right clickable"></span>';
				var label = '<label class="control-label ' + status + ' text-wrap clickable" for="inputSuccess1">' + display_name + '</label>';
				var content = label + icon + image;

				if (drawOnline && online) {
					showMe = true
					$('#twitchChannelsOnline').append('<li class="list-group-item clickable" ' + onclick + '>' + content + '</li>');
				} else if (! drawOnline && ! online) {
					showMe = true
					$('#twitchChannelsOffline').append('<li class="list-group-item clickable" ' + onclick + '>' + content + '</li>');
				}
			}
			return showMe
		}
		function loadTwitchChannelData() {
			if ($( "#twitchChannelsOnline" ).parents('.col').is(":visible")) {
				var dataUrl = "{{ url_for('dashboard_method_json', netHandle=box.netHandle, methodHandle=box.handle) }}";
				$.getJSON( dataUrl ).done( function( data ) {

					$( "#twitchChannelsOnline" ).fadeOut( 200, function () {
						$('#twitchChannelsOnline').empty();
						if (drawStreamContent( data, true )) {
							$( "#twitchChannelsOnline" ).fadeIn( 200 );
						}
					});

					$( "#twitchChannelsOffline" ).fadeOut( 200, function () {
						$('#twitchChannelsOffline').empty();
						if (drawStreamContent( data, false )) {
							$( "#twitchChannelsOffline" ).fadeIn( 200 );
						}
					});

				});
			}
		}
		loadTwitchChannelData();
		setInterval(loadTwitchChannelData, 30000 );
	})();
</script>